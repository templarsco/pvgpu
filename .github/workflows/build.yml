name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Rust Backend Build
  # ============================================================================
  backend:
    name: Backend (Rust)
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        working-directory: backend
        run: cargo fmt --all -- --check
      
      - name: Clippy
        working-directory: backend
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      - name: Build
        working-directory: backend
        run: cargo build --release
      
      - name: Run tests
        working-directory: backend
        run: cargo test --release
      
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvgpu-backend-windows
          path: backend/target/release/pvgpu-backend.exe
          if-no-files-found: ignore

  # ============================================================================
  # Protocol Header Validation
  # ============================================================================
  protocol:
    name: Protocol Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc
      
      - name: Validate C header compiles
        run: |
          echo '#include "pvgpu_protocol.h"' > test.c
          echo 'int main() { return sizeof(PvgpuControlRegion) == 4096 ? 0 : 1; }' >> test.c
          gcc -c test.c -I protocol/ -o test.o
          echo "Protocol header validates successfully"

  # ============================================================================
  # QEMU Device (Syntax Check Only - needs QEMU source for full build)
  # ============================================================================
  qemu-device:
    name: QEMU Device (Syntax Check)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc
      
      - name: Check C syntax (standalone)
        run: |
          # Create minimal stub headers for syntax check
          mkdir -p stubs/qemu stubs/hw/pci stubs/hw/qdev stubs/qapi stubs/sysemu
          
          # Create minimal stubs
          cat > stubs/qemu/osdep.h << 'EOF'
          #ifndef QEMU_OSDEP_H
          #define QEMU_OSDEP_H
          #include <stdint.h>
          #include <stdbool.h>
          #include <stddef.h>
          #include <string.h>
          #include <stdlib.h>
          typedef uint64_t hwaddr;
          #define g_malloc0(x) calloc(1, x)
          #define g_free(x) free(x)
          #define qemu_log_mask(...)
          #define LOG_GUEST_ERROR 0
          #define MiB (1024*1024)
          #define OBJECT(x) ((void*)x)
          #define DEVICE_CLASS(x) ((void*)x)
          #define PCI_DEVICE_CLASS(x) ((void*)x)
          #define DEVICE_CATEGORY_DISPLAY 0
          #define set_bit(a,b)
          #define DEFINE_PROP_UINT32(a,b,c,d)
          #define DEFINE_PROP_STRING(a,b,c)
          #define DEFINE_PROP_END_OF_LIST()
          #define OBJECT_DECLARE_SIMPLE_TYPE(a,b) typedef struct a a;
          #define type_init(x)
          #define type_register_static(x)
          EOF
          
          cat > stubs/qemu/units.h << 'EOF'
          #ifndef QEMU_UNITS_H
          #define QEMU_UNITS_H
          #endif
          EOF
          
          cat > stubs/qemu/module.h << 'EOF'
          #ifndef QEMU_MODULE_H
          #define QEMU_MODULE_H
          #endif
          EOF
          
          cat > stubs/qemu/error-report.h << 'EOF'
          #ifndef QEMU_ERROR_REPORT_H
          #define QEMU_ERROR_REPORT_H
          #endif
          EOF
          
          cat > stubs/hw/pci/pci_device.h << 'EOF'
          #ifndef HW_PCI_PCI_DEVICE_H
          #define HW_PCI_PCI_DEVICE_H
          #include <stdint.h>
          typedef struct PCIDevice { int dummy; } PCIDevice;
          typedef struct ObjectClass ObjectClass;
          typedef struct DeviceClass { const char* desc; void* categories; void (*reset)(void*); } DeviceClass;
          typedef struct PCIDeviceClass { 
            void (*realize)(PCIDevice*, void**); 
            void (*exit)(PCIDevice*);
            uint16_t vendor_id, device_id, subsystem_vendor_id, subsystem_id;
            uint8_t revision;
            uint32_t class_id;
          } PCIDeviceClass;
          typedef struct Property Property;
          typedef struct MemoryRegion { int dummy; } MemoryRegion;
          typedef struct MemoryRegionOps { 
            uint64_t (*read)(void*, uint64_t, unsigned);
            void (*write)(void*, uint64_t, uint64_t, unsigned);
            int endianness;
            struct { int min_access_size; int max_access_size; } impl;
          } MemoryRegionOps;
          typedef struct TypeInfo { 
            const char* name; 
            const char* parent; 
            size_t instance_size;
            void (*class_init)(ObjectClass*, void*);
            void* interfaces;
          } TypeInfo;
          typedef struct InterfaceInfo { const char* type; } InterfaceInfo;
          typedef struct Error Error;
          #define PCI_DEVICE(x) ((PCIDevice*)x)
          #define TYPE_PCI_DEVICE "pci-device"
          #define INTERFACE_PCIE_DEVICE "pcie-device"
          #define PCI_BASE_ADDRESS_SPACE_MEMORY 0
          #define PCI_BASE_ADDRESS_MEM_PREFETCH 0
          #define DEVICE_LITTLE_ENDIAN 0
          static inline void memory_region_init_io(MemoryRegion* mr, void* owner, const MemoryRegionOps* ops, void* opaque, const char* name, uint64_t size) {}
          static inline void memory_region_init_ram_ptr(MemoryRegion* mr, void* owner, const char* name, uint64_t size, void* ptr) {}
          static inline void pci_register_bar(PCIDevice* d, int n, int t, MemoryRegion* mr) {}
          static inline void pci_irq_assert(PCIDevice* d) {}
          static inline void device_class_set_props(DeviceClass* dc, Property* props) {}
          static inline void error_setg(Error** e, const char* fmt, ...) {}
          static inline void error_free(Error* e) {}
          EOF
          
          cat > stubs/hw/pci/msi.h << 'EOF'
          #ifndef HW_PCI_MSI_H
          #define HW_PCI_MSI_H
          #endif
          EOF
          
          cat > stubs/hw/pci/msix.h << 'EOF'
          #ifndef HW_PCI_MSIX_H
          #define HW_PCI_MSIX_H
          #include "pci_device.h"
          static inline int msix_init_exclusive_bar(PCIDevice* d, int nvec, int bar, Error** e) { return -1; }
          static inline void msix_uninit_exclusive_bar(PCIDevice* d) {}
          static inline void msix_notify(PCIDevice* d, int v) {}
          #endif
          EOF
          
          cat > stubs/hw/qdev-properties.h << 'EOF'
          #ifndef HW_QDEV_PROPERTIES_H
          #define HW_QDEV_PROPERTIES_H
          #endif
          EOF
          
          cat > stubs/qapi/error.h << 'EOF'
          #ifndef QAPI_ERROR_H
          #define QAPI_ERROR_H
          #endif
          EOF
          
          cat > stubs/sysemu/sysemu.h << 'EOF'
          #ifndef SYSEMU_SYSEMU_H
          #define SYSEMU_SYSEMU_H
          #endif
          EOF
          
          # Now try to compile
          gcc -fsyntax-only -I stubs -I stubs/hw/pci -I protocol qemu-device/pvgpu.c 2>&1 || echo "Note: Full build requires QEMU source tree"

  # ============================================================================
  # Driver Skeleton Check (Windows)
  # Note: Full driver build requires WDK which is not available in GitHub Actions
  # ============================================================================
  driver-check:
    name: Driver Structure Check
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check driver directory structure
        run: |
          Write-Host "Checking driver directory structure..."
          
          # Check KMD files
          if (Test-Path "driver/kmd/pvgpu.c") { Write-Host "[OK] KMD source: pvgpu.c" } else { Write-Host "[MISSING] driver/kmd/pvgpu.c"; exit 1 }
          if (Test-Path "driver/kmd/pvgpu.h") { Write-Host "[OK] KMD header: pvgpu.h" } else { Write-Host "[MISSING] driver/kmd/pvgpu.h"; exit 1 }
          if (Test-Path "driver/kmd/pvgpu.inf") { Write-Host "[OK] KMD INF: pvgpu.inf" } else { Write-Host "[MISSING] driver/kmd/pvgpu.inf"; exit 1 }
          if (Test-Path "driver/kmd/pvgpu.vcxproj") { Write-Host "[OK] KMD Project: pvgpu.vcxproj" } else { Write-Host "[MISSING] driver/kmd/pvgpu.vcxproj"; exit 1 }
          
          Write-Host ""
          
          # Check UMD files
          if (Test-Path "driver/umd/pvgpu_umd.c") { Write-Host "[OK] UMD source: pvgpu_umd.c" } else { Write-Host "[MISSING] driver/umd/pvgpu_umd.c"; exit 1 }
          if (Test-Path "driver/umd/pvgpu_umd.h") { Write-Host "[OK] UMD header: pvgpu_umd.h" } else { Write-Host "[MISSING] driver/umd/pvgpu_umd.h"; exit 1 }
          if (Test-Path "driver/umd/pvgpu_umd.def") { Write-Host "[OK] UMD DEF: pvgpu_umd.def" } else { Write-Host "[MISSING] driver/umd/pvgpu_umd.def"; exit 1 }
          if (Test-Path "driver/umd/pvgpu_umd.vcxproj") { Write-Host "[OK] UMD Project: pvgpu_umd.vcxproj" } else { Write-Host "[MISSING] driver/umd/pvgpu_umd.vcxproj"; exit 1 }
          
          Write-Host ""
          Write-Host "Driver skeleton structure verified successfully!"
          Write-Host "Note: Full driver build requires Visual Studio 2022 + WDK"
      
      - name: Validate INF file syntax
        run: |
          Write-Host "Validating INF file..."
          $inf = Get-Content "driver/kmd/pvgpu.inf" -Raw
          
          # Check required sections exist
          $requiredSections = @("[Version]", "[Manufacturer]", "[SourceDisksFiles]", "[DestinationDirs]")
          foreach ($section in $requiredSections) {
            if ($inf -match [regex]::Escape($section)) {
              Write-Host "[OK] Found section: $section"
            } else {
              Write-Host "[ERROR] Missing required section: $section"
              exit 1
            }
          }
          
          # Check PCI IDs match protocol
          if ($inf -match "VEN_1AF4") { Write-Host "[OK] Vendor ID matches protocol (0x1AF4)" }
          if ($inf -match "DEV_10F0") { Write-Host "[OK] Device ID matches protocol (0x10F0)" }
          
          Write-Host "INF file validation passed!"

  # ============================================================================
  # Documentation
  # ============================================================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check required docs exist
        run: |
          test -f README.md && echo "README.md exists"
          test -f CONTRIBUTING.md && echo "CONTRIBUTING.md exists"
          test -f LICENSE-MIT && echo "LICENSE-MIT exists"
          test -f LICENSE-APACHE && echo "LICENSE-APACHE exists"

  # ============================================================================
  # Release Build
  # ============================================================================
  release:
    name: Release Build
    runs-on: windows-latest
    needs: [backend, protocol]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: pvgpu-backend-windows
          path: release/
      
      - name: Package release
        run: |
          mkdir -p release/protocol
          Copy-Item protocol/pvgpu_protocol.h release/protocol/
          Copy-Item README.md release/
          Compress-Archive -Path release/* -DestinationPath pvgpu-release.zip
      
      - name: Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: pvgpu-release
          path: pvgpu-release.zip
